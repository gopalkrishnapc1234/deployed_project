<!DOCTYPE html>
<html lang="en">
  <%- include('partials/head') %>
<body class="bg-light">
  <%- include('partials/navbar') %>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2 bg-white vh-100 border-end py-4" style="position:sticky; top:0;">
        <div class="px-3">
          <h5 class="mb-3">Admin Panel</h5>
          <div class="list-group">
            <a href="#users" class="list-group-item list-group-item-action">Registered Users</a>
            <a href="#post-job" class="list-group-item list-group-item-action">Post Job</a>
            <a href="#applied" class="list-group-item list-group-item-action">Applied Users</a>
          </div>
        </div>
      </div>

      <!-- Main -->
      <div class="col-md-9 col-lg-10 py-4">
        <div class="container">

          <!-- Registered Users -->
          <section id="users" class="mb-4">
            <h4>Registered Users</h4>
            <div class="accordion" id="userAccordion">
              <% if (users.length === 0) { %>
                <div class="alert alert-info">No registered users yet.</div>
              <% } %>

              <% users.forEach((u, i) => { %>
                <div class="accordion-item">
                  <h2 class="accordion-header" id="heading-<%= i %>">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-<%= i %>">
                      <div>
                        <div class="fw-bold"><%= u.name %></div>
                        <div class="small text-muted"><%= u.email %></div>
                      </div>
                    </button>
                  </h2>
                  <div id="collapse-<%= i %>" class="accordion-collapse collapse" data-bs-parent="#userAccordion">
                    <div class="accordion-body">
                      <p><strong>Registered:</strong> <%= new Date(u.createdAt).toLocaleString() %></p>
                      <p><strong>User ID:</strong> <%= u._id %></p>
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
          </section>

          <!-- Posted Jobs -->
          <section id="jobs-list" class="mb-4">
            <h4>Posted Jobs</h4>
            <% if (jobs.length === 0) { %>
              <div class="alert alert-info">No jobs posted yet.</div>
            <% } %>
            <div class="list-group mb-3">
              <% jobs.forEach(j => { %>
                <div class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <div class="fw-bold"><%= j.title %></div>
                    <div class="small text-muted"><%= j.company %> â€¢ <%= j.location %></div>
                  </div>
                  <div>
                    <form method="POST" action="/admin/job/delete/<%= j._id %>" onsubmit="return confirm('Are you sure you want to delete this job? This will remove all associated applications.')">
                      <button class="btn btn-sm btn-outline-danger">Delete</button>
                    </form>
                  </div>
                </div>
              <% }) %>
            </div>
          </section>

          <!-- Post New Job -->
          <section id="post-job" class="mb-4">
            <h4>Post New Job</h4>
            <form action="/admin/job" method="POST">
              <div class="row">
                <div class="col-md-6 mb-2">
                  <input name="title" class="form-control" placeholder="Job title" required>
                </div>
                <div class="col-md-3 mb-2">
                  <input name="company" class="form-control" placeholder="Company (optional)">
                </div>
                <div class="col-md-3 mb-2">
                  <input name="location" class="form-control" placeholder="Location (optional)">
                </div>
              </div>
              <div class="mb-2">
                <textarea name="description" class="form-control" rows="4" placeholder="Job description" required></textarea>
              </div>
              <button class="btn btn-primary">Post Job</button>
            </form>
          </section>

          <!-- Applied Users (Accordion Format by Job) -->
          <section id="applied" class="mb-4">
            <h4>Applied Users</h4>
            <% if (applied.length === 0) { %>
              <div class="alert alert-info">Nobody applied yet.</div>
            <% } else { %>
              <% 
                const grouped = {};
                applied.forEach(a => {
                  const jobId = a.job ? a.job._id : 'unknown';
                  if (!grouped[jobId]) grouped[jobId] = { job: a.job, users: [] };
                  grouped[jobId].users.push(a);
                });
              %>

              <div class="accordion" id="appliedAccordion">
                <% Object.keys(grouped).forEach((jobId, index) => { 
                    const jobData = grouped[jobId];
                %>
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="applied-heading-<%= index %>">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#applied-collapse-<%= index %>">
                        <div>
                          <div class="fw-bold"><%= jobData.job ? jobData.job.title : 'Deleted Job' %></div>
                          <div class="small text-muted"><%= jobData.job && jobData.job.company ? jobData.job.company : '' %></div>
                        </div>
                      </button>
                    </h2>
                    <div id="applied-collapse-<%= index %>" class="accordion-collapse collapse" data-bs-parent="#appliedAccordion">
                      <div class="accordion-body">
                        <% if (jobData.users.length === 0) { %>
                          <div class="text-muted small">No applicants for this job.</div>
                        <% } else { %>
                          <div class="table-responsive">
                            <table class="table table-striped align-middle mb-0">
                              <thead>
                                <tr>
                                  <th>User</th>
                                  <th>Applied At</th>
                                  <th>Actions</th>
                                </tr>
                              </thead>
                              <tbody>
                                <% jobData.users.forEach(a => { %>
                                  <tr>
                                    <td>
                                      <strong><%= a.user ? a.user.name : 'Unknown' %></strong>
                                      <div class="small text-muted"><%= a.user ? a.user.email : '' %></div>
                                    </td>
                                    <td class="small text-muted"><%= new Date(a.appliedAt).toLocaleString() %></td>
                                    <td>
                                      <% if (a.resume && a.resume.data) { %>
                                        <a href="/admin/resume/<%= a._id %>" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                                          View Resume
                                        </a>
                                      <% } else { %>
                                        <span class="text-muted small">No resume</span>
                                      <% } %>

                                      <!-- Select / Reject Buttons -->
                                      <button class="btn btn-sm btn-success select-btn">Select</button>
                                      <button class="btn btn-sm btn-danger reject-btn">Reject</button>
                                    </td>
                                  </tr>
                                <% }) %>
                              </tbody>
                            </table>
                          </div>
                        <% } %>
                      </div>
                    </div>
                  </div>
                <% }) %>
              </div>
            <% } %>
          </section>

        </div>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>

  <!-- JS for Select/Reject Logic -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.select-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const td = btn.parentElement;
          const rejectBtn = td.querySelector('.reject-btn');
          btn.remove(); // remove select button
          if (rejectBtn) rejectBtn.remove(); // remove reject button
          const span = document.createElement('span');
          span.className = 'fw-bold text-success';
          span.textContent = 'Selected';
          td.appendChild(span);
        });
      });

      document.querySelectorAll('.reject-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const td = btn.parentElement;
          const selectBtn = td.querySelector('.select-btn');
          btn.remove(); // remove reject button
          if (selectBtn) selectBtn.remove(); // remove select button
          const span = document.createElement('span');
          span.className = 'fw-bold text-danger';
          span.textContent = 'Rejected';
          td.appendChild(span);
        });
      });
    });
  </script>
</body>
</html>
